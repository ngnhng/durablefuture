# Copyright 2025 Nguyen Nhat Nguyen
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

resources:
  - name: DurableFuture Backend
    subtitle: Workflow Orchestration Platform
    description: Temporal-inspired deterministic workflows on NATS JetStream
    color: "#0B7285"
    children:
      - name: Server
        subtitle: cmd/durablefuture-server
        description: Handles commands, ensures JetStream resources, spawns projectors
        children:
          - name: Manager Loop
            subtitle: internal/server/app/manager.go
            description: Bootstraps infra and supervises projectors

          - name: Command Handler
            subtitle: internal/server/handler
            description: Processes command.request.* subjects from SDK

          - name: Projection Suite
            style: flat
            subtitle: internal/server/projection
            children:
              - name: WorkflowTasks Projector
                subtitle: workflow_tasks.go
                description: Emits workflow.<id>.tasks from history events

              - name: ActivityTasks Projector
                subtitle: activity_tasks.go
                description: Publishes activity.<fn>.tasks when ActivityScheduled occurs

              - name: WorkflowResults Projector
                subtitle: workflow_results.go
                description: Writes WorkflowCompleted payloads into workflow-result KV

              - name: ActivityRetries Projector
                subtitle: activity_retries.go
                description: Repairs failed activities based on retry policy

      - name: NATS JetStream
        subtitle: Durable Messaging
        description: Streams and KV backing workflow history, tasks, and metadata
        children:
          - name: command.request.start
            subtitle: Subject
            description: SDK start workflow commands

          - name: WORKFLOW_HISTORY
            subtitle: Stream (history.<workflowID>)
            children:
              - name: WorkflowStarted
              - name: ActivityScheduled
              - name: ActivityCompleted
              - name: WorkflowCompleted

          - name: WORKFLOW_TASKS
            subtitle: Stream (workflow.<workflowID>.tasks)

          - name: ACTIVITY_TASKS
            subtitle: Stream (activity.<activityFn>.tasks)

          - name: workflow-input
            subtitle: KV bucket
            description: Stores serialized workflow inputs keyed by workflow ID

          - name: workflow-result
            subtitle: KV bucket
            description: Holds final workflow outputs for futures/clients

          - name: workflow-metadata
            subtitle: KV bucket
            description: Status + visibility data surfaced in the console

  - name: Your System
    color: Green
    children:
      - name: Dashboard
        subtitle: frontend/app
        description: Optional Vite + React console visualizing runs
        icon: Azure/General/Shared Dashboard.svg
      - name: DurableFuture Workers
        style: flat
        subtitle: Runtime Processes
        children:
          - name: Workflow Worker
            subtitle: workflow-worker container
            description: Replays history via Chronicle and runs workflow code
            children:
              - name: Workflow Business Logic
              - name: Workflow SDK
                instanceOf: Client SDK
                children:
                  - name: Workflow API
                    subtitle: sdk/workflow
                    description: Deterministic workflow context + ExecuteActivity helpers
                  - name: Workflow Worker Runtime

          - name: Activity Worker
            subtitle: activity-worker container
            description: Executes non-deterministic functions with retry policies
            children:
              - name: Activity Business Logic
              - name: Activity SDK
                instanceOf: Client SDK
                children:
                  - name: Activity API
                    subtitle: sdk/activity
                    description: Activity registration and handler plumbing
                  - name: Activity Worker Runtime

      - name: Your Application
        children:
          - name: Client API
            instanceOf: Client SDK

  - name: Client SDK
    abstract: true
    color: GreenYellow
    subtitle: pkg/client-sdk
    description: Public API for starting workflows, executing activities, and resolving futures
    children:
      - name: Worker Runtime
        subtitle: sdk/worker
        description: Runs workflow/activity workers and hosts Chronicle replay

  - name: DurableFuture Codebase
    subtitle: Repository Modules
    color: "#495057"
    icon: _demo/git.png
    children:
      - name: API Contracts
        subtitle: api/events.go, api/types.go
        description: Shared structs imported by SDK + server

      - name: SDK Internals
        subtitle: sdk/internal/**
        description: Replay engine, futures, pending activity cache
        children:
          - name: Activity Replay Engine
            subtitle: sdk/internal/activity_replay.go

          - name: Future Pending Cache
            subtitle: sdk/internal/future_pending.go

          - name: Context Propagation
            subtitle: sdk/internal/context.go

      - name: Server Infra
        subtitle: internal/server/infra/jetstream
        description: JetStream connection helpers and consumer utilities

      - name: Examples
        subtitle: examples/scenarios/*
        description: Runnable scenarios (order, order-retries, recovery, etc.)
        children:
          - name: Order Workflow
            subtitle: examples/scenarios/order/order.go

          - name: Order Retries
            subtitle: examples/scenarios/order-retries/order_retries.go

perspectives:
  - name: Deployment
    color: SteelBlue
    relations:
      - from: Client API
        to: Command Handler
        label: Publish command.request.start
      - from: Manager Loop
        to: WORKFLOW_HISTORY
        label: Append WorkflowStarted
      - from: Manager Loop
        to: workflow-input
        label: Store inputs
      - from: WorkflowTasks Projector
        to: WORKFLOW_TASKS
        label: Publish workflow.<id>.tasks
      - from: Workflow SDK
        to: WORKFLOW_TASKS
        label: Consume & replay
      - from: Workflow SDK
        to: WORKFLOW_HISTORY
        label: Emit ActivityScheduled
      - from: ActivityTasks Projector
        to: ACTIVITY_TASKS
        label: Publish activity.<fn>.tasks
      - from: Activity SDK
        to: ACTIVITY_TASKS
        label: Consume + execute
      - from: Activity SDK
        to: Command Handler
        label: Report completion/failure
      - from: Command Handler
        to: WORKFLOW_HISTORY
        label: Append ActivityCompleted/Failed
      - from: WorkflowResults Projector
        to: workflow-result
        label: Store final payload
      - from: Client API
        to: workflow-result
        label: Watch for result
      - from: Dashboard
        to: workflow-metadata
        label: Display run state

  - name: Deterministic Execution Flow
    color: Firebrick
    sequence:
      start: Client API
      steps:
        - to: Client API
          label: ExecuteWorkflow()
          description: SDK serializes StartWorkflow command
        - to: Command Handler
          label: HandleStartWorkflow
        - to: WORKFLOW_HISTORY
          label: Append WorkflowStarted
        - to: WorkflowTasks Projector
          label: Consume history
        - to: WORKFLOW_TASKS
          label: Publish workflow.<id>.tasks
        - to: Workflow Worker
          label: Replay + run workflow fn
        - to: WORKFLOW_HISTORY
          label: Emit ActivityScheduled
        - to: ActivityTasks Projector
          label: Build ActivityTask payload
        - to: ACTIVITY_TASKS
          label: Publish activity.<fn>.tasks
        - to: Activity Worker
          label: Execute activity w/ retries
        - to: Command Handler
          label: Report completion
        - to: WORKFLOW_HISTORY
          label: Append ActivityCompleted
        - to: Workflow Worker
          label: Resume replay for next decision
        - to: WORKFLOW_HISTORY
          label: Append WorkflowCompleted
        - to: WorkflowResults Projector
          label: Materialize result
        - to: workflow-result
          label: Put workflow-result/<id>
        - to: Client API
          label: Future resolves to caller

  - name: Reliability & Retry
    color: DarkGreen
    relations:
      - from: ActivityRetries Projector
        to: ACTIVITY_TASKS
        label: Requeue retry attempt
      - from: WORKFLOW_HISTORY
        to: ActivityRetries Projector
        label: Observe ActivityFailed, RetryStateUpdated
      - from: Activity Worker
        to: WORKFLOW_HISTORY
        label: Append ActivityFailed w/ retry state
      - from: Activity Worker Runtime
        to: Activity Replay Engine
        label: Chronicle replay decisions
      - from: Manager Loop
        to: workflow-metadata
        label: Persist status for UI
description: |-
  Mirrors the DurableFuture architecture described in CLAUDE.md/README.md: deterministic Go workflows send commands through the SDK, the server projects workflow and activity tasks via JetStream, workers execute logic, and results materialize in KV buckets while retry projectors maintain reliability.
