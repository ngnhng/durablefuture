<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DurableFuture Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Syntax highlighting for Go code */
      .go-keyword {
        color: #ff79c6;
        font-weight: 600;
      }
      .go-type {
        color: #8be9fd;
      }
      .go-function {
        color: #50fa7b;
      }
      .go-string {
        color: #f1fa8c;
      }
      .go-number {
        color: #bd93f9;
      }
      .go-comment {
        color: #6272a4;
        font-style: italic;
      }
      .go-operator {
        color: #ff79c6;
      }
      .go-field {
        color: #f8f8f2;
      }

      .code-step {
        position: relative;
        display: block;
        margin-left: -12px;
        padding: 6px 10px 6px 14px;
        border-left: 3px solid transparent;
        border-radius: 6px;
        transition: background-color 0.2s ease, border-color 0.2s ease;
      }

      .code-step[data-step-label]::before {
        content: attr(data-step-label);
        position: absolute;
        top: -0.75rem;
        left: 0.5rem;
        font-size: 0.6rem;
        letter-spacing: 0.1em;
        color: rgba(255, 255, 255, 0.55);
      }

      .code-highlight-active {
        background: rgba(59, 130, 246, 0.18);
        border-left-color: rgb(59, 130, 246);
      }

      .code-highlight-completed {
        background: rgba(34, 197, 94, 0.2);
        border-left-color: rgb(34, 197, 94);
      }

      .code-highlight-failed {
        background: rgba(239, 68, 68, 0.18);
        border-left-color: rgb(239, 68, 68);
      }

      /* Event stack animations */
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-10px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .event-item {
        animation: slideIn 0.3s ease-out;
      }

      /* Scrollbar styling */
      .event-stack::-webkit-scrollbar {
        width: 8px;
      }

      .event-stack::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      .event-stack::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      .event-stack::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>
  <body class="bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">
          DurableFuture Demo
        </h1>
        <p class="text-lg text-gray-600">
          A Temporal-inspired workflow orchestration engine built on NATS
          JetStream
        </p>
        <p class="text-sm text-gray-500 mt-2">
          Watch automatic activity retries with exponential backoff in real-time
        </p>
      </div>

      <!-- Main Demo Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Left: Code Display -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h2 class="text-xl font-semibold mb-4">Workflow Code</h2>
          <pre
            class="bg-gray-900 text-gray-100 p-4 rounded-lg overflow-x-auto text-sm leading-relaxed"
          ><code id="workflow-code"><span class="go-keyword">func</span> <span class="go-function">OrderWithRetriesWorkflow</span>(
    <span class="go-field">ctx</span> <span class="go-type">workflow.Context</span>,
    <span class="go-field">orderID</span> <span class="go-type">string</span>,
    <span class="go-field">customerID</span> <span class="go-type">string</span>,
    <span class="go-field">amount</span> <span class="go-type">float64</span>,
) (<span class="go-type">any</span>, <span class="go-type">error</span>) {
    <span class="code-step" id="step-validate-order" data-step-label="STEP 1">
        <span class="go-comment">// Validate inputs before doing expensive work</span>
        <span class="go-keyword">var</span> <span class="go-field">validation</span> <span class="go-type">OrderValidationResult</span>
        workflow.<span class="go-function">ExecuteActivity</span>(
            ctx,
            <span class="go-function">ValidateOrderDetailsActivity</span>,
            <span class="go-type">OrderValidationRequest</span>{OrderID: orderID, CustomerID: customerID, Amount: amount},
        ).<span class="go-function">Get</span>(ctx, <span class="go-operator">&amp;</span>validation)
    </span>

    <span class="code-step" id="step-payment" data-step-label="STEP 2">
        <span class="go-comment">// Charge the customer with exponential backoff retries</span>
        <span class="go-field">paymentCtx</span> <span class="go-operator">:=</span> workflow.<span class="go-function">WithActivityOptions</span>(ctx,
            workflow.<span class="go-type">ActivityOptions</span>{
                <span class="go-field">RetryPolicy</span>: <span class="go-operator">&amp;</span>workflow.<span class="go-type">RetryPolicy</span>{
                    <span class="go-field">InitialInterval</span>: <span class="go-number">2</span> <span class="go-operator">*</span> time.Second,
                    <span class="go-field">BackoffCoefficient</span>: <span class="go-number">2.0</span>,
                    <span class="go-field">MaximumAttempts</span>: <span class="go-number">5</span>,
                },
            },
        )
        <span class="go-keyword">var</span> <span class="go-field">payment</span> <span class="go-type">PaymentResult</span>
        workflow.<span class="go-function">ExecuteActivity</span>(
            paymentCtx,
            <span class="go-function">TransientFailurePaymentActivity</span>,
            <span class="go-type">PaymentRequest</span>{OrderID: orderID, CustomerID: customerID, Amount: amount},
        ).<span class="go-function">Get</span>(ctx, <span class="go-operator">&amp;</span>payment)
    </span>

    <span class="code-step" id="step-inventory" data-step-label="STEP 3">
        <span class="go-comment">// Reserve inventory with its own retry policy</span>
        <span class="go-field">inventoryCtx</span> <span class="go-operator">:=</span> workflow.<span class="go-function">WithActivityOptions</span>(ctx,
            workflow.<span class="go-type">ActivityOptions</span>{
                <span class="go-field">RetryPolicy</span>: <span class="go-operator">&amp;</span>workflow.<span class="go-type">RetryPolicy</span>{
                    <span class="go-field">InitialInterval</span>: time.Second,
                    <span class="go-field">MaximumAttempts</span>: <span class="go-number">4</span>,
                },
            },
        )
        <span class="go-keyword">var</span> <span class="go-field">reservation</span> <span class="go-type">InventoryReservation</span>
        workflow.<span class="go-function">ExecuteActivity</span>(
            inventoryCtx,
            <span class="go-function">ReserveInventoryActivity</span>,
            <span class="go-type">InventoryRequest</span>{OrderID: orderID, Quantity: <span class="go-number">1</span>, Warehouse: "central"},
        ).<span class="go-function">Get</span>(ctx, <span class="go-operator">&amp;</span>reservation)
    </span>

    <span class="code-step" id="step-packaging" data-step-label="STEP 4">
        <span class="go-comment">// Package the order once stock is locked</span>
        <span class="go-keyword">var</span> <span class="go-field">packResult</span> <span class="go-type">PackageResult</span>
        workflow.<span class="go-function">ExecuteActivity</span>(
            ctx,
            <span class="go-function">PackageOrderActivity</span>,
            <span class="go-type">PackageRequest</span>{OrderID: orderID, Reservation: reservation},
        ).<span class="go-function">Get</span>(ctx, <span class="go-operator">&amp;</span>packResult)
    </span>

    <span class="code-step" id="step-shipping" data-step-label="STEP 5">
        <span class="go-comment">// Ship with a more aggressive retry configuration</span>
        <span class="go-field">shippingCtx</span> <span class="go-operator">:=</span> workflow.<span class="go-function">WithActivityOptions</span>(ctx,
            workflow.<span class="go-type">ActivityOptions</span>{
                <span class="go-field">RetryPolicy</span>: <span class="go-operator">&amp;</span>workflow.<span class="go-type">RetryPolicy</span>{
                    <span class="go-field">InitialInterval</span>: time.Second,
                    <span class="go-field">BackoffCoefficient</span>: <span class="go-number">1.5</span>,
                    <span class="go-field">MaximumAttempts</span>: <span class="go-number">10</span>,
                },
            },
        )
        <span class="go-keyword">var</span> <span class="go-field">shipping</span> <span class="go-type">ShippingResult</span>
        workflow.<span class="go-function">ExecuteActivity</span>(
            shippingCtx,
            <span class="go-function">EventuallySuccessfulShippingActivity</span>,
            <span class="go-type">ShippingRequest</span>{OrderID: orderID, Payment: payment},
        ).<span class="go-function">Get</span>(ctx, <span class="go-operator">&amp;</span>shipping)
    </span>

    <span class="code-step" id="step-notify" data-step-label="STEP 6">
        <span class="go-comment">// Let the customer know the happy path succeeded</span>
        <span class="go-keyword">var</span> <span class="go-field">notification</span> <span class="go-type">NotificationResult</span>
        workflow.<span class="go-function">ExecuteActivity</span>(
            ctx,
            <span class="go-function">NotifyCustomerActivity</span>,
            <span class="go-type">NotificationRequest</span>{OrderID: orderID, Email: customerID + "@example.com", Status: "shipped"},
        ).<span class="go-function">Get</span>(ctx, <span class="go-operator">&amp;</span>notification)
    </span>

    <span class="code-step" id="workflow-return-highlight" data-step-label="RESULT">
        <span class="go-keyword">return</span> map[<span class="go-type">string</span>]<span class="go-type">any</span>{
            "charge_id":   payment.ChargeID,
            "tracking_id": shipping.TrackingID,
            "package_id":  packResult.PackageID,
            "notified_via": notification.Channel,
        }, <span class="go-keyword">nil</span>
    </span>
}</code></pre>
        </div>

        <!-- Right: Controls and Event Stack -->
        <div class="space-y-6">
          <!-- Controls -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-xl font-semibold mb-4">Controls</h2>
            <div class="space-y-3">
              <button
                id="start-btn"
                onclick="startWorkflow()"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors"
              >
                ðŸš€ Launch Workflow
              </button>

              <div class="pt-2 border-t">
                <p class="text-sm text-gray-600 mb-2 font-medium">
                  Test Crash Recovery:
                </p>
                <div class="space-y-2">
                  <button
                    id="crash-server-btn"
                    onclick="crashComponent('server')"
                    disabled
                    class="w-full bg-red-600 hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white text-sm font-medium py-2 px-3 rounded transition-colors"
                  >
                    ðŸ’¥ Crash Server
                  </button>
                  <button
                    id="crash-workflow-worker-btn"
                    onclick="crashComponent('workflow-worker')"
                    disabled
                    class="w-full bg-orange-600 hover:bg-orange-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white text-sm font-medium py-2 px-3 rounded transition-colors"
                  >
                    ðŸ’¥ Crash Workflow Worker
                  </button>
                  <button
                    id="crash-activity-worker-btn"
                    onclick="crashComponent('activity-worker')"
                    disabled
                    class="w-full bg-orange-600 hover:bg-orange-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white text-sm font-medium py-2 px-3 rounded transition-colors"
                  >
                    ðŸ’¥ Crash Activity Worker
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Event Stack -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-semibold">Execution Timeline</h2>
              <button
                id="clear-events-btn"
                onclick="clearEvents()"
                class="text-sm text-gray-500 hover:text-gray-700"
                style="display: none"
              >
                Clear
              </button>
            </div>
            <div
              id="workflow-info"
              class="mb-3 pb-3 border-b"
              style="display: none"
            >
              <div class="flex items-center justify-between text-sm">
                <span class="text-gray-600">Workflow ID:</span>
                <span
                  id="workflow-id-display"
                  class="font-mono text-xs text-gray-900"
                ></span>
              </div>
              <div class="flex items-center justify-between text-sm mt-1">
                <span class="text-gray-600">Status:</span>
                <span
                  id="workflow-status-badge"
                  class="px-2 py-0.5 rounded text-xs font-medium"
                ></span>
              </div>
            </div>
            <div
              id="event-stack"
              class="event-stack space-y-2 max-h-[32rem] overflow-y-auto"
            >
              <p class="text-gray-500 text-center py-8 text-sm">
                Click "Launch Workflow" to start
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Info Section -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-blue-900 mb-2">How It Works</h3>
        <ul class="list-disc list-inside space-y-1 text-blue-800">
          <li>
            <strong>Automatic Retries:</strong> Activities fail initially and
            are retried with exponential backoff
          </li>
          <li>
            <strong>Event Sourcing:</strong> All workflow state is stored as
            immutable events in NATS JetStream
          </li>
          <li>
            <strong>Deterministic Replay:</strong> Workflows can recover from
            crashes by replaying history
          </li>
          <li>
            <strong>Distributed Fault Tolerance:</strong> Try crashing any
            component during execution - the workflow will recover!
          </li>
        </ul>
        <div class="mt-4 p-3 bg-blue-100 rounded">
          <p class="text-sm text-blue-900">
            <strong>ðŸ’¡ Try this:</strong> Launch a workflow, then crash the
            activity worker mid-execution. Watch Docker Compose auto-restart it
            and the workflow continue seamlessly!
          </p>
        </div>
      </div>
    </div>

    <script>
      let pollInterval = null;
      let currentWorkflowId = null;
      let events = [];
      let lastEventCount = 0;
      let lastHighlightedCodeId = null;

      const ACTIVITY_CODE_MAP = {
        "github.com/ngnhng/durablefuture/examples/scenarios/order-retries.ValidateOrderDetailsActivity":
          "step-validate-order",
        "github.com/ngnhng/durablefuture/examples/scenarios/order-retries.TransientFailurePaymentActivity":
          "step-payment",
        "github.com/ngnhng/durablefuture/examples/scenarios/order-retries.ReserveInventoryActivity":
          "step-inventory",
        "github.com/ngnhng/durablefuture/examples/scenarios/order-retries.PackageOrderActivity":
          "step-packaging",
        "github.com/ngnhng/durablefuture/examples/scenarios/order-retries.EventuallySuccessfulShippingActivity":
          "step-shipping",
        "github.com/ngnhng/durablefuture/examples/scenarios/order-retries.NotifyCustomerActivity":
          "step-notify",
      };

      async function startWorkflow() {
        try {
          const response = await fetch("/api/demo/start", { method: "POST" });
          const data = await response.json();
          currentWorkflowId = data.workflow_id;

          // Reset event stack
          events = [];
          lastEventCount = 0;
          clearHighlights({ resetHistory: true });
          document.getElementById("event-stack").innerHTML = "";
          document.getElementById("workflow-info").style.display = "block";
          document.getElementById("workflow-id-display").textContent =
            currentWorkflowId;
          document.getElementById("clear-events-btn").style.display = "inline";

          document.getElementById("start-btn").disabled = true;
          document.getElementById("crash-server-btn").disabled = false;
          document.getElementById("crash-workflow-worker-btn").disabled = false;
          document.getElementById("crash-activity-worker-btn").disabled = false;

          // Start polling for status
          if (pollInterval) clearInterval(pollInterval);
          pollInterval = setInterval(updateStatus, 500);
          updateStatus();
        } catch (error) {
          console.error("Failed to start workflow:", error);
          alert("Failed to start workflow: " + error.message);
        }
      }

      async function crashComponent(component) {
        const componentNames = {
          server: "Server",
          "workflow-worker": "Workflow Worker",
          "activity-worker": "Activity Worker",
        };

        const name = componentNames[component];
        const message =
          component === "server"
            ? `This will crash the ${name}. You'll need to manually restart it with 'docker compose up -d server'.`
            : `This will crash the ${name}. Docker Compose will auto-restart it and the workflow should continue.`;

        if (!confirm(message + " Continue?")) {
          return;
        }

        const endpoints = {
          server: "/api/demo/crash",
          "workflow-worker": "http://localhost:8081/crash",
          "activity-worker": "http://localhost:8082/crash",
        };

        try {
          await fetch(endpoints[component], { method: "POST" });

          // Add event to stack
          addEvent({
            type: "system",
            icon: "ðŸ’¥",
            title: `${name} Crashed`,
            message:
              component === "server"
                ? "Manually restart required"
                : "Auto-restarting...",
            color: "red",
            timestamp: new Date(),
          });
        } catch (error) {
          if (component === "server") {
            addEvent({
              type: "system",
              icon: "ðŸ’¥",
              title: "Server Crashed",
              message: "Restart with: docker compose up -d server",
              color: "red",
              timestamp: new Date(),
            });
          }
        }
      }

      async function updateStatus() {
        try {
          const response = await fetch("/api/demo/status");
          const state = await response.json();

          if (state.status === "no_workflow") {
            return;
          }

          // Update workflow status badge
          updateWorkflowStatusBadge(state.status);

          // Process events from state
          processStateEvents(state);

          updateCodeHighlights(state);

          // Stop polling if workflow is done
          if (state.status === "completed" || state.status === "failed") {
            clearInterval(pollInterval);
            document.getElementById("crash-server-btn").disabled = true;
            document.getElementById(
              "crash-workflow-worker-btn"
            ).disabled = true;
            document.getElementById(
              "crash-activity-worker-btn"
            ).disabled = true;
            setTimeout(() => {
              document.getElementById("start-btn").disabled = false;
            }, 2000);
          }
        } catch (error) {
          console.error("Failed to fetch status:", error);
        }
      }

      function processStateEvents(state) {
        // Check for workflow started
        if (
          state.status !== "pending" &&
          !events.find((e) => e.type === "workflow_started")
        ) {
          addEvent({
            type: "workflow_started",
            icon: "ðŸš€",
            title: "Workflow Started",
            message: "OrderWithRetriesWorkflow",
            color: "blue",
            timestamp: new Date(state.started_at),
          });
        }

        // Process step details to generate events
        state.step_details?.forEach((step, index) => {
          const activityName = formatActivityName(step.name);

          // Check for activity scheduled
          if (
            step.attempts > 0 &&
            !events.find(
              (e) =>
                e.type === "activity_scheduled" &&
                e.activityName === activityName
            )
          ) {
            addEvent({
              type: "activity_scheduled",
              icon: "ðŸ“‹",
              title: "Activity Scheduled",
              message: activityName,
              color: "gray",
              timestamp: step.started_at
                ? new Date(step.started_at)
                : new Date(),
              activityName,
            });
          }

          // Check for retries
          if (step.attempts > 1) {
            const existingRetries = events.filter(
              (e) =>
                e.type === "activity_retried" && e.activityName === activityName
            ).length;

            if (existingRetries < step.attempts - 1) {
              addEvent({
                type: "activity_retried",
                icon: "ðŸ”„",
                title: "Activity Retrying",
                message: `${activityName} - Attempt ${step.attempts}`,
                detail: step.error || "Transient failure, retrying...",
                color: "yellow",
                timestamp: new Date(),
                activityName,
              });
            }
          }

          // Check for activity completed
          if (
            step.status === "completed" &&
            !events.find(
              (e) =>
                e.type === "activity_completed" &&
                e.activityName === activityName
            )
          ) {
            addEvent({
              type: "activity_completed",
              icon: "âœ…",
              title: "Activity Completed",
              message: `${activityName} - Attempt ${step.attempts}`,
              color: "green",
              timestamp: step.ended_at ? new Date(step.ended_at) : new Date(),
              activityName,
            });
          }

          // Check for activity failed (permanent)
          if (
            step.status === "failed" &&
            !events.find(
              (e) =>
                e.type === "activity_failed" && e.activityName === activityName
            )
          ) {
            addEvent({
              type: "activity_failed",
              icon: "âŒ",
              title: "Activity Failed",
              message: activityName,
              detail: step.error,
              color: "red",
              timestamp: new Date(),
              activityName,
            });
          }
        });

        // Check for workflow completed
        if (
          state.status === "completed" &&
          !events.find((e) => e.type === "workflow_completed")
        ) {
          addEvent({
            type: "workflow_completed",
            icon: "ðŸŽ‰",
            title: "Workflow Completed",
            message: "Order processing successful",
            detail: formatWorkflowResult(state.result),
            color: "green",
            timestamp: state.completed_at
              ? new Date(state.completed_at)
              : new Date(),
          });
        }

        // Check for workflow failed
        if (
          state.status === "failed" &&
          !events.find((e) => e.type === "workflow_failed")
        ) {
          addEvent({
            type: "workflow_failed",
            icon: "ðŸ’”",
            title: "Workflow Failed",
            message: state.error || "Unknown error",
            color: "red",
            timestamp: state.completed_at
              ? new Date(state.completed_at)
              : new Date(),
          });
        }
      }

      function updateCodeHighlights(state) {
        clearHighlights();
        if (!state) return;

        let targetId = null;

        (state.step_details || []).forEach((step) => {
          const codeId = ACTIVITY_CODE_MAP[step.name];
          if (!codeId) return;
          const el = document.getElementById(codeId);
          if (!el) return;

          if (step.status === "running") {
            el.classList.add("code-highlight-active");
            targetId = codeId;
          } else if (step.status === "completed") {
            el.classList.add("code-highlight-completed");
          } else if (step.status === "failed") {
            el.classList.add("code-highlight-failed");
            targetId = codeId;
          }
        });

        if (state.status === "completed") {
          const returnEl = document.getElementById("workflow-return-highlight");
          if (returnEl) {
            returnEl.classList.add("code-highlight-completed");
            targetId = targetId || "workflow-return-highlight";
          }
        }

        if (targetId && targetId !== lastHighlightedCodeId) {
          scrollCodeIntoView(targetId);
          lastHighlightedCodeId = targetId;
        }
      }

      function scrollCodeIntoView(elementId) {
        const el = document.getElementById(elementId);
        if (!el) return;
        el.scrollIntoView({
          behavior: "smooth",
          block: "center",
          inline: "nearest",
        });
      }

      function addEvent(event) {
        events.push(event);

        const eventStack = document.getElementById("event-stack");
        const eventEl = createEventElement(event);
        eventStack.appendChild(eventEl);

        // Auto-scroll to bottom
        eventStack.scrollTop = eventStack.scrollHeight;
      }

      function createEventElement(event) {
        const div = document.createElement("div");
        div.className = `event-item p-3 rounded-lg border-l-4 ${getEventBorderColor(
          event.color
        )} ${getEventBgColor(event.color)}`;

        const timestamp = event.timestamp.toLocaleTimeString("en-US", {
          hour12: false,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          fractionalSecondDigits: 3,
        });

        div.innerHTML = `
          <div class="flex items-start gap-3">
            <span class="text-xl flex-shrink-0">${event.icon}</span>
            <div class="flex-1 min-w-0">
              <div class="flex items-baseline justify-between gap-2">
                <span class="font-medium text-sm ${getEventTextColor(
                  event.color
                )}">${event.title}</span>
                <span class="text-xs text-gray-500 flex-shrink-0">${timestamp}</span>
              </div>
              <div class="text-sm text-gray-700 mt-0.5">${event.message}</div>
              ${
                event.detail
                  ? `<div class="text-xs text-gray-600 mt-1 font-mono bg-gray-100 p-2 rounded overflow-x-auto">${event.detail}</div>`
                  : ""
              }
            </div>
          </div>
        `;

        return div;
      }

      function updateWorkflowStatusBadge(status) {
        const badge = document.getElementById("workflow-status-badge");
        badge.textContent = status.toUpperCase();
        badge.className = `px-2 py-0.5 rounded text-xs font-medium ${getStatusColor(
          status
        )}`;
      }

      function clearEvents() {
        if (!confirm("Clear all events?")) return;
        events = [];
        lastEventCount = 0;
        clearHighlights({ resetHistory: true });
        document.getElementById("event-stack").innerHTML = `
          <p class="text-gray-500 text-center py-8 text-sm">
            Click "Launch Workflow" to start
          </p>
        `;
        document.getElementById("workflow-info").style.display = "none";
        document.getElementById("clear-events-btn").style.display = "none";
      }

      function clearHighlights(options = {}) {
        document.querySelectorAll(".code-step").forEach((el) => {
          el.classList.remove(
            "code-highlight-active",
            "code-highlight-completed",
            "code-highlight-failed"
          );
        });

        if (options.resetHistory) {
          lastHighlightedCodeId = null;
        }
      }

      function getStatusColor(status) {
        switch (status) {
          case "completed":
            return "bg-green-100 text-green-800";
          case "failed":
            return "bg-red-100 text-red-800";
          case "running":
            return "bg-blue-100 text-blue-800";
          default:
            return "bg-gray-100 text-gray-800";
        }
      }

      function getEventBorderColor(color) {
        const colors = {
          blue: "border-blue-500",
          green: "border-green-500",
          red: "border-red-500",
          yellow: "border-yellow-500",
          gray: "border-gray-400",
        };
        return colors[color] || colors.gray;
      }

      function getEventBgColor(color) {
        const colors = {
          blue: "bg-blue-50",
          green: "bg-green-50",
          red: "bg-red-50",
          yellow: "bg-yellow-50",
          gray: "bg-gray-50",
        };
        return colors[color] || colors.gray;
      }

      function getEventTextColor(color) {
        const colors = {
          blue: "text-blue-900",
          green: "text-green-900",
          red: "text-red-900",
          yellow: "text-yellow-900",
          gray: "text-gray-900",
        };
        return colors[color] || colors.gray;
      }

      function formatActivityName(name) {
        // Extract just the activity name from the full path
        const shortName = name.split(".").pop();
        return shortName
          .replace(/Activity$/, "")
          .replace(/([A-Z])/g, " $1")
          .trim();
      }

      function formatWorkflowResult(result) {
        if (!result) return null;

        try {
          const parsed =
            typeof result === "string" ? JSON.parse(result) : result;
          return JSON.stringify(parsed, null, 2);
        } catch (err) {
          console.warn("Failed to parse workflow result", err);
          return typeof result === "string" ? result : JSON.stringify(result);
        }
      }
    </script>
  </body>
</html>
